<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Trang Profile Ng∆∞·ªùi D√πng</title>
  <link rel="stylesheet" href="/CSS/Profiles.css">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&family=Playfair+Display:wght@500&display=swap" rel="stylesheet">
</head>
<body>
  <!-- Video n·ªÅn -->
  <video class="video-bg" autoplay muted loop>
    <source src="/BG VIDEO/Car 4k wallpaper.mp4" type="video/mp4">
    Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ video n·ªÅn.
  </video>

  <!-- Profile Card -->
  <div class="profile-wrapper">
    <div class="profile-card">
      <div class="avatar-box">
        <img id="avatar" src="https://via.placeholder.com/150" alt="Avatar" />
      </div>
      <div class="profile-info">
        <h2 id="fullname">ƒêang t·∫£i...</h2>
        <p class="username">@<span id="username">ƒêang t·∫£i...</span></p>
        <p class="email">üìß <span id="email">ƒêang t·∫£i...</span></p>
      </div>
    </div>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    const SUPABASE_URL = 'https://wxozonwykuutwkjxyxew.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind4b3pvbnd5a3V1dHdranh5eGV3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk3MzgwMjUsImV4cCI6MjA2NTMxNDAyNX0.9lZuachKdX2NmDLXAZsP3aMlhAL3ZAMepUXPKPCwt9Q';

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // H√†m t·∫°o avatar ng·∫´u nhi√™n
    function getRandomAvatar() {
      const seed = Math.floor(Math.random() * 10000);
      return `https://api.dicebear.com/7.x/thumbs/svg?seed=${seed}`;
    }

    document.addEventListener("DOMContentLoaded", async () => {
      const { data: { user }, error: userError } = await supabase.auth.getUser();

      if (userError || !user) {
        alert("B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p ho·∫∑c phi√™n ƒëƒÉng nh·∫≠p h·∫øt h·∫°n!");
        return;
      }

      try {
        const { data, error } = await supabase
          .from('profiles')
          .select('fullname, email, username') // B·ªè avatar_url
          .eq('uid', user.id)
          .maybeSingle();

        if (error) throw error;
        if (!data) {
          alert("Kh√¥ng t√¨m th·∫•y th√¥ng tin ng∆∞·ªùi d√πng.");
          return;
        }

        document.getElementById('fullname').textContent = data.fullname ?? 'Kh√¥ng c√≥ t√™n';
        document.getElementById('email').textContent = data.email ?? 'Kh√¥ng c√≥ email';
        document.getElementById('username').textContent = data.username ?? 'Kh√¥ng c√≥ username';

        // ƒê·∫∑t avatar ng·∫´u nhi√™n ban ƒë·∫ßu
        const avatarImg = document.getElementById('avatar');
        avatarImg.src = getRandomAvatar();

        // Cho ph√©p click ƒë·ªÉ ƒë·ªïi avatar ng·∫´u nhi√™n kh√°c
        avatarImg.style.cursor = 'pointer';
        avatarImg.title = 'B·∫•m ƒë·ªÉ ƒë·ªïi avatar';
        avatarImg.addEventListener('click', () => {
          avatarImg.src = getRandomAvatar();
        });

      } catch (error) {
        alert("Kh√¥ng th·ªÉ t·∫£i th√¥ng tin ng∆∞·ªùi d√πng: " + error.message);
      }
    });
  </script>
</body>
</html>
